<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Car Comparison AI</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            color: #334155;
        }
        .car-item {
            background-color: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: transform 0.5s ease-out, opacity 0.5s ease-out, background-color 0.3s ease;
            cursor: pointer;
            position: relative;
            will-change: transform;
            z-index: 1;
        }

        /* Bring hovered item to front */
        .car-item:hover {
            z-index: 10;
        }

        /* Active (perfect match) styling */
        .car-item.active {
            border-color: #f59e0b; /* More vibrant orange */
            box-shadow: 0 8px 16px rgba(245, 158, 11, 0.25);
            background-color: #fef3c7; /* Bright orange background */
        }

        /* Special styling for the ONLY perfect match */
        .car-item.active.only-perfect-match {
            transform: scale(1.05);
            border-width: 3px;
            border-color: #dc2626; /* Red border for ultimate emphasis */
            box-shadow: 0 12px 24px rgba(220, 38, 38, 0.3), 0 0 0 4px rgba(220, 38, 38, 0.1);
            background: linear-gradient(135deg, #fef3c7 0%, #fed7aa 50%, #fef3c7 100%);
            animation: perfectMatchPulse 2s ease-in-out infinite;
            z-index: 20;
            position: relative;
            margin: 15px 15px 15px 15px; /* Reduced top margin since no badge */
        }

        @keyframes perfectMatchPulse {
            0%, 100% {
                transform: scale(1.05);
                box-shadow: 0 12px 24px rgba(220, 38, 38, 0.3), 0 0 0 4px rgba(220, 38, 38, 0.1);
            }
            50% {
                transform: scale(1.08);
                box-shadow: 0 16px 32px rgba(220, 38, 38, 0.4), 0 0 0 6px rgba(220, 38, 38, 0.2);
            }
        }

        /* Partial match styling - medium opacity */
        .car-item.partial {
            border-color: #2563eb; /* Blue border for partial matches */
            background-color: #dbeafe; /* Light blue background */
        }
        .car-item.partial .car-content {
            opacity: 0.75; /* Medium opacity */
            color: #78716c; /* Slightly muted text */
        }

        /* Inactive (no match) styling - most muted */
        .car-item.inactive {
            border-color: #e5e7eb; /* Even lighter border */
            background-color: #f3f4f6; /* Muted gray background */
        }
        .car-item.inactive .car-content {
            opacity: 0.4; /* Lowest opacity */
            color: #94a3b8; /* Most muted text color */
        }

        .chat-window, .facet-sidebar {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: width 0.5s ease-in-out, padding 0.5s ease-in-out;
            flex-shrink: 0;
            overflow: hidden;
            height: 100%; /* Ensure it takes full vertical height */
        }

        /* Specific styling for the left facet sidebar */
        .facet-sidebar {
            background-color: #334155; /* Darker background */
            color: #e2e8f0; /* Lighter text */
            padding: 1rem;
            margin-right: 1rem; /* Space between sidebar and car list */
            width: 20%; /* Adjusted width for the sidebar */
            max-height: calc(100vh - 96px); /* Full remaining height after header and padding */
            overflow-y: auto; /* Enable scrolling for facets */
        }

        .facet-sidebar label, .facet-sidebar h3 {
            color: #f8fafc; /* Even lighter text for labels/headers */
        }

        .facet-sidebar select, .facet-sidebar input[type="range"], .facet-sidebar input[type="number"], .facet-sidebar input[type="checkbox"] {
            background-color: #475569; /* Darker input background */
            border-color: #64748b; /* Darker border */
            color: #f8fafc; /* Lighter text */
            border-radius: 6px;
        }

        .facet-sidebar input[type="range"]::-webkit-slider-thumb {
            background-color: #2563eb;
        }
        .facet-sidebar input[type="range"]::-moz-range-thumb {
            background-color: #2563eb;
        }

        .chat-drawer-open {
            width: 25%; /* Adjusted for three-column layout */
            padding: 1rem; /* p-4 */
        }

        .chat-drawer-closed {
            width: 0; /* Truly collapsed */
            padding: 0; /* Remove padding when collapsed */
            margin: 0; /* Remove margin when collapsed */
            border: 0; /* Remove border when collapsed */
        }

        .chat-message.user {
            background-color: #dbeafe;
            border-radius: 12px 12px 2px 12px;
            align-self: flex-end;
        }

        .chat-message.ai {
            background-color: #e2e8f0;
            border-radius: 12px 12px 12px 2px;
            align-self: flex-start;
        }

        .tooltip {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.85);
            color: white !important;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.875rem;
            white-space: normal;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            max-width: 400px;
            left: 50%;
            transform: translateX(-50%);
            top: 100%;
            bottom: auto;
            margin-top: 10px;
        }
        .car-item .tooltip {
            opacity: 1 !important;
            color: white !important;
            background-color: rgba(0, 0, 0, 0.85) !important;
        }

        .car-item:hover .tooltip {
            opacity: 1;
            visibility: visible;
        }

        /* Loading indicator for chat */
        .loading-dots span {
            animation: blink 1.4s infinite both;
        }
        .loading-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }
        .loading-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }
        @keyframes blink {
            0% { opacity: 0.2; }
            20% { opacity: 1; }
            100% { opacity: 0.2; }
        }

        /* Car list transition for smooth resizing */
        #car-list-container-wrapper {
            transition: width 0.5s ease-in-out, margin-right 0.5s ease-in-out;
            height: auto;
        }

        #car-list-container {
            overflow-y: auto;
            max-height: calc(100vh - 96px); /* Match the other elements - just header height */
        }

        #chat-drawer {
            height: calc(100vh - 96px); /* Full remaining height after header and padding */
            display: flex;
            flex-direction: column;
        }

        #chat-content {
            display: flex;
            flex-direction: column;
            height: 100%;
            min-height: 0; /* Important: allows flex children to shrink */
        }

        #chat-messages {
            flex: 1;
            min-height: 0; /* Important: allows the div to shrink and scroll */
            overflow-y: auto;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen pt-0 items-center">
    <!-- Global Header -->
    <div class="w-full bg-white p-4 shadow-md mb-4">
        <h1 class="text-4xl font-extrabold text-gray-900 text-left ml-4">Cars R'Us</h1>
    </div>

    <div class="flex w-full flex-grow items-start px-4 relative">
        <!-- Left Facet Sidebar -->
        <div id="facet-sidebar" class="facet-sidebar flex flex-col rounded-xl pb-4">
            <!-- Removed "Filter Cars" header as requested -->
            <h2 class="text-2xl font-bold mb-4 text-center sr-only">Filter Cars</h2>

            <!-- Brand Filter -->
            <div class="mb-4">
                <h3 class="font-semibold mb-2">Brand</h3>
                <select id="facet-brand" class="w-full p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">All Brands</option>
                    <!-- Options will be dynamically populated -->
                </select>
            </div>

            <!-- Car Type Filter -->
            <div class="mb-4">
                <h3 class="font-semibold mb-2">Car Type</h3>
                <div id="facet-car-type" class="flex flex-col space-y-2">
                    <!-- Checkboxes will be dynamically populated -->
                </div>
            </div>

            <!-- Price Filter -->
            <div class="mb-4">
                <h3 class="font-semibold mb-2">Price Range</h3>
                <div class="space-y-2">
                    <div>
                        <label for="facet-price-min" class="text-sm">Min Price</label>
                        <input type="range" id="facet-price-min" min="10000" max="100000" step="1000" value="10000" class="w-full">
                        <p class="text-sm text-right mt-1">$<span id="facet-price-min-value">10,000</span></p>
                    </div>
                    <div>
                        <label for="facet-price-max" class="text-sm">Max Price</label>
                        <input type="range" id="facet-price-max" min="10000" max="100000" step="1000" value="100000" class="w-full">
                        <p class="text-sm text-right mt-1">$<span id="facet-price-max-value">100,000</span></p>
                    </div>
                </div>
            </div>

            <!-- MPG Filter -->
            <div class="mb-4">
                <h3 class="font-semibold mb-2">Min Highway MPG</h3>
                <input type="range" id="facet-mpg-range" min="10" max="60" step="1" value="10" class="w-full">
                <p class="text-sm text-right mt-1"><span id="facet-mpg-value">10</span> MPG or more</p>
            </div>

            <!-- Seating Capacity Filter -->
            <div class="mb-4">
                <h3 class="font-semibold mb-2">Min Seating</h3>
                <select id="facet-seating" class="w-full p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">Any</option>
                    <option value="2">2+</option>
                    <option value="4">4+</option>
                    <option value="5">5+</option>
                    <option value="6">6+</option>
                    <option value="7">7+</option>
                    <option value="8">8+</option>
                    <option value="9">9+</option>
                </select>
            </div>

            <!-- Features Filter -->
            <div class="mb-4">
                <h3 class="font-semibold mb-2">Features</h3>
                <div id="facet-features" class="flex flex-col space-y-2">
                    <!-- Checkboxes will be dynamically populated -->
                </div>
            </div>

            <button id="facet-reset-button" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 mt-4">
                Reset Filters
            </button>
        </div>

        <!-- Car List (Middle Content Area) - Dynamically sized -->
        <div id="car-list-container-wrapper" class="flex flex-col px-4 w-3/5 mr-4">
            <div id="car-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 overflow-y-auto h-full">
                <!-- Car items will be rendered here -->
            </div>
        </div>

        <!-- Drawer Toggle Button - Positioned to hover outside chat window -->
        <button id="drawer-toggle" class="fixed top-24 right-4 p-2 rounded-full hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 z-30 bg-white shadow-lg border border-gray-200">
            <!-- Hamburger/Close Icon - using SVG for simplicity -->
            <svg id="toggle-icon-open" class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
            <svg id="toggle-icon-closed" class="w-6 h-6 text-gray-600 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
        </button>

        <!-- Chat Window (Right Sidebar) - Collapsible drawer -->
        <div id="chat-drawer" class="flex flex-col chat-window chat-drawer-open pb-4">
            <div id="chat-drawer-header" class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-800 flex-grow text-left">AI Car Assistant</h2>
            </div>
            <div id="chat-content" class="flex-grow flex flex-col min-h-0">
                <div id="chat-messages" class="flex-1 mb-4 p-3 border border-gray-200 rounded-lg bg-gray-50 min-h-0">
                    <!-- Chat messages will be appended here -->
                    <div class="chat-message ai p-3 my-2 max-w-[80%]">
                        Hi there! I can help you find your perfect car. Tell me what you're looking for, or say "guide me" and I'll ask you questions to find your ideal match!
                    </div>
                </div>
                <div class="flex w-full flex-shrink-0">
                    <input type="text" id="user-input" placeholder="Type your preferences..."
                           class="flex-grow p-3 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-blue-500 min-w-0">
                    <button id="send-button"
                            class="bg-blue-600 text-white px-6 py-3 rounded-r-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-500">
                        Send
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Car Data ---
        const cars = [
            // Honda Group
            { id: 'car1', make: 'Honda', model: 'CR-V', price: 30000, mpg: { city: 28, highway: 34 }, seating: 5, features: ['Apple CarPlay', 'AWD', 'sunroof', 'adaptive cruise control'], safetyRating: 5, type: 'SUV', imageUrl: 'https://placehold.co/400x250/E0F2F7/0288D1?text=Honda+CR-V' },
            { id: 'car2', make: 'Honda', model: 'Accord', price: 26000, mpg: { city: 32, highway: 42 }, seating: 5, features: ['Apple CarPlay', 'Honda Sensing', 'sunroof'], safetyRating: 5, type: 'Sedan', imageUrl: 'https://placehold.co/400x250/E0F2F7/0288D1?text=Honda+Accord' },
            { id: 'car3', make: 'Honda', model: 'Pilot', price: 38000, mpg: { city: 20, highway: 27 }, seating: 8, features: ['Apple CarPlay', 'AWD', '3rd row seating', 'wireless charging'], safetyRating: 5, type: 'SUV', imageUrl: 'https://placehold.co/400x250/E0F2F7/0288D1?text=Honda+Pilot' },
            
            // Toyota Group
            { id: 'car4', make: 'Toyota', model: 'Camry', price: 28000, mpg: { city: 29, highway: 38 }, seating: 5, features: ['Android Auto', 'FWD', 'blind spot monitor'], safetyRating: 5, type: 'Sedan', imageUrl: 'https://placehold.co/400x250/E8F5E9/388E3C?text=Toyota+Camry' },
            { id: 'car5', make: 'Toyota', model: 'RAV4', price: 32000, mpg: { city: 27, highway: 35 }, seating: 5, features: ['Apple CarPlay', 'AWD', 'Toyota Safety Sense'], safetyRating: 5, type: 'SUV', imageUrl: 'https://placehold.co/400x250/E8F5E9/388E3C?text=Toyota+RAV4' },
            { id: 'car6', make: 'Toyota', model: 'Highlander', price: 40000, mpg: { city: 21, highway: 29 }, seating: 8, features: ['Apple CarPlay', 'AWD', '3rd row seating', 'JBL audio'], safetyRating: 5, type: 'SUV', imageUrl: 'https://placehold.co/400x250/E8F5E9/388E3C?text=Toyota+Highlander' },
            
            // Ford Group
            { id: 'car7', make: 'Ford', model: 'F-150', price: 40000, mpg: { city: 20, highway: 26 }, seating: 6, features: ['Towing Package', '4x4', 'large bed'], safetyRating: 4, type: 'Truck', imageUrl: 'https://placehold.co/400x250/E0F7FA/00BCD4?text=Ford+F-150' },
            { id: 'car8', make: 'Ford', model: 'Explorer', price: 36000, mpg: { city: 21, highway: 28 }, seating: 7, features: ['Apple CarPlay', 'AWD', '3rd row seating', 'SYNC 4'], safetyRating: 4, type: 'SUV', imageUrl: 'https://placehold.co/400x250/E0F7FA/00BCD4?text=Ford+Explorer' },
            { id: 'car9', make: 'Ford', model: 'Mustang Mach-E', price: 48000, mpg: { city: 105, highway: 93 }, seating: 5, features: ['Fast Charging', 'AWD', 'panoramic glass roof', 'SYNC 4A'], safetyRating: 5, type: 'EV', imageUrl: 'https://placehold.co/400x250/E0F7FA/00BCD4?text=Ford+Mustang+Mach-E' },
            
            // Tesla Group
            { id: 'car10', make: 'Tesla', model: 'Model 3', price: 45000, mpg: { city: 132, highway: 121 }, seating: 5, features: ['Autopilot', 'AWD', 'panoramic glass roof', 'fast charging'], safetyRating: 5, type: 'EV', imageUrl: 'https://placehold.co/400x250/F3E5F5/7B1FA2?text=Tesla+Model+3' },
            { id: 'car11', make: 'Tesla', model: 'Model Y', price: 52000, mpg: { city: 125, highway: 115 }, seating: 7, features: ['Autopilot', 'AWD', 'panoramic glass roof', 'fast charging', '3rd row seating'], safetyRating: 5, type: 'EV', imageUrl: 'https://placehold.co/400x250/F3E5F5/7B1FA2?text=Tesla+Model+Y' },
            
            // Chevrolet Group
            { id: 'car12', make: 'Chevrolet', model: 'Bolt EV', price: 27000, mpg: { city: 120, highway: 100 }, seating: 5, features: ['Fast Charging', 'Apple CarPlay', 'Backup Camera'], safetyRating: 5, type: 'EV', imageUrl: 'https://placehold.co/400x250/E1F5FE/0277BD?text=Chevrolet+Bolt+EV' },
            { id: 'car13', make: 'Chevrolet', model: 'Tahoe', price: 52000, mpg: { city: 16, highway: 20 }, seating: 9, features: ['Towing Package', '4x4', '3rd row seating', 'Bose audio'], safetyRating: 4, type: 'SUV', imageUrl: 'https://placehold.co/400x250/E1F5FE/0277BD?text=Chevrolet+Tahoe' },
            
            // BMW Group
            { id: 'car14', make: 'BMW', model: 'X5', price: 60000, mpg: { city: 21, highway: 26 }, seating: 5, features: ['Leather Seats', 'Panoramic Sunroof', 'Heated Seats', 'Navigation'], safetyRating: 5, type: 'SUV', imageUrl: 'https://placehold.co/400x250/FBE9E7/D84315?text=BMW+X5' },
            { id: 'car15', make: 'BMW', model: '3 Series', price: 41000, mpg: { city: 26, highway: 36 }, seating: 5, features: ['Leather Seats', 'Heated Seats', 'Navigation', 'Harman Kardon audio'], safetyRating: 5, type: 'Sedan', imageUrl: 'https://placehold.co/400x250/FBE9E7/D84315?text=BMW+3+Series' },
            
            // Hyundai Group
            { id: 'car16', make: 'Hyundai', model: 'Elantra', price: 22000, mpg: { city: 31, highway: 41 }, seating: 5, features: ['Apple CarPlay', 'Android Auto', 'Lane Keeping Assist'], safetyRating: 4, type: 'Sedan', imageUrl: 'https://placehold.co/400x250/FCE4EC/AD1457?text=Hyundai+Elantra' },
        ];

        // --- User Preferences (will be updated by chat and facets) ---
        let userPreferences = {
            brand: null,
            priceRange: null, // Changed from maxPrice to priceRange: {min: number, max: number}
            minMPGHighway: null,
            seatingCapacity: null,
            carType: null, // Can be a string like 'SUV' or an array if multiple types are allowed
            features: null
        };

        // --- Guided Experience State ---
        let isGuided = false;
        let guidedStep = 0;
        let guidedQuestions = [
            {
                question: "What's your budget range? (e.g., 'under 30k', 'between 25k and 40k', or 'around 35k')",
                preference: 'priceRange',
                pattern: /(?:between\s*\$*(\d+k?)\s*and\s*\$*(\d+k?)|under\s*\$*(\d+k?)|over\s*\$*(\d+k?)|around\s*\$*(\d+k?))/i
            },
            {
                question: "What type of vehicle are you looking for? (SUV, Sedan, Truck, or Electric Vehicle)",
                preference: 'carType',
                pattern: /(suv|sedan|truck|electric|ev)/i
            },
            {
                question: "Do you have a brand preference? (Honda, Toyota, Ford, Tesla, BMW, Chevrolet, Hyundai, or 'no preference')",
                preference: 'brand',
                pattern: /(honda|toyota|ford|tesla|bmw|chevrolet|hyundai|no preference)/i
            },
            {
                question: "How many seats do you need? (2, 4, 5, 6, 7, 8, or 9)",
                preference: 'seatingCapacity',
                pattern: /(\d+)\s*seats?/i
            },
            {
                question: "Is fuel efficiency important to you? (e.g., 'yes', 'at least 30 mpg', or 'not important')",
                preference: 'minMPGHighway',
                pattern: /(yes|at least (\d+)|not important|\d+ mpg)/i
            }
        ];

        // --- DOM Elements ---
        const chatMessagesDiv = document.getElementById('chat-messages');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const carListContainer = document.getElementById('car-list-container');
        const carListContainerWrapper = document.getElementById('car-list-container-wrapper');
        const chatDrawer = document.getElementById('chat-drawer');
        const drawerToggle = document.getElementById('drawer-toggle');
        const toggleIconOpen = document.getElementById('toggle-icon-open');
        const toggleIconClosed = document.getElementById('toggle-icon-closed');
        const chatContent = document.getElementById('chat-content');
        const chatDrawerHeader = document.getElementById('chat-drawer-header');

        // Facet DOM Elements
        const facetBrandSelect = document.getElementById('facet-brand');
        const facetCarTypeDiv = document.getElementById('facet-car-type');
        const facetPriceMin = document.getElementById('facet-price-min');
        const facetPriceMax = document.getElementById('facet-price-max');
        const facetPriceMinValueSpan = document.getElementById('facet-price-min-value');
        const facetPriceMaxValueSpan = document.getElementById('facet-price-max-value');
        const facetMpgRange = document.getElementById('facet-mpg-range');
        const facetMpgValueSpan = document.getElementById('facet-mpg-value');
        const facetSeatingSelect = document.getElementById('facet-seating');
        const facetFeaturesDiv = document.getElementById('facet-features');
        const facetResetButton = document.getElementById('facet-reset-button');

        let isDrawerOpen = true; // Initial state: drawer is open

        // --- Utility Functions ---

        // Function to add a message to the chat window
        function addChatMessage(message, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('chat-message', sender, 'p-3', 'my-2', 'max-w-[80%]', 'shadow-sm');
            messageDiv.textContent = message;
            chatMessagesDiv.appendChild(messageDiv);
            chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight; // Scroll to bottom
        }

        // Function to start guided experience
        function startGuidedExperience() {
            isGuided = true;
            guidedStep = 0;
            // Reset preferences for a fresh start
            userPreferences = {
                brand: null,
                priceRange: null,
                minMPGHighway: null,
                seatingCapacity: null,
                carType: null,
                features: null
            };
            updateFacetUI();
            askNextGuidedQuestion();
        }

        // Function to ask the next guided question
        function askNextGuidedQuestion() {
            if (guidedStep >= guidedQuestions.length) {
                // All questions answered, check results
                const rankedCars = rankCars(cars, userPreferences);
                const perfectMatches = rankedCars.filter(car => car.isPerfectMatch);
                
                if (perfectMatches.length === 1) {
                    addChatMessage(`Perfect! Based on your preferences, I found the ideal car for you: the ${perfectMatches[0].make} ${perfectMatches[0].model}. It's highlighted above!`, 'ai');
                    isGuided = false;
                } else if (perfectMatches.length === 0) {
                    addChatMessage("I couldn't find a perfect match with all your criteria, but I've ranked the cars by how well they match your preferences. The top ones are your best options!", 'ai');
                    isGuided = false;
                } else {
                    addChatMessage(`Great! I found ${perfectMatches.length} cars that match all your criteria. You can see them highlighted above, or feel free to ask me more specific questions to narrow it down further.`, 'ai');
                    isGuided = false;
                }
                return;
            }

            const question = guidedQuestions[guidedStep];
            addChatMessage(question.question, 'ai');
        }

        // Function to process guided response
        function processGuidedResponse(input) {
            const question = guidedQuestions[guidedStep];
            const lowerInput = input.toLowerCase();
            let processed = false;

            switch (question.preference) {
                case 'priceRange':
                    const rangeMatch = lowerInput.match(/between\s*\$*(\d+k?)\s*and\s*\$*(\d+k?)/);
                    const underMatch = lowerInput.match(/under\s*\$*(\d+k?)/);
                    const overMatch = lowerInput.match(/over\s*\$*(\d+k?)/);
                    const aroundMatch = lowerInput.match(/around\s*\$*(\d+k?)/);
                    
                    if (rangeMatch) {
                        let minPrice = parseInt(rangeMatch[1].replace('k', '000'), 10);
                        let maxPrice = parseInt(rangeMatch[2].replace('k', '000'), 10);
                        userPreferences.priceRange = { value: {min: minPrice, max: maxPrice}, weight: 3, description: `price between $${minPrice.toLocaleString()} and $${maxPrice.toLocaleString()}` };
                        addChatMessage(`Got it! Looking for cars between $${minPrice.toLocaleString()} and $${maxPrice.toLocaleString()}.`, 'ai');
                        processed = true;
                    } else if (underMatch) {
                        let maxPrice = parseInt(underMatch[1].replace('k', '000'), 10);
                        userPreferences.priceRange = { value: {min: 10000, max: maxPrice}, weight: 3, description: `price under $${maxPrice.toLocaleString()}` };
                        addChatMessage(`Perfect! Focusing on cars under $${maxPrice.toLocaleString()}.`, 'ai');
                        processed = true;
                    } else if (overMatch) {
                        let minPrice = parseInt(overMatch[1].replace('k', '000'), 10);
                        userPreferences.priceRange = { value: {min: minPrice, max: 100000}, weight: 3, description: `price over $${minPrice.toLocaleString()}` };
                        addChatMessage(`Understood! Looking for cars over $${minPrice.toLocaleString()}.`, 'ai');
                        processed = true;
                    } else if (aroundMatch) {
                        let targetPrice = parseInt(aroundMatch[1].replace('k', '000'), 10);
                        let minPrice = Math.max(10000, targetPrice - 5000);
                        let maxPrice = Math.min(100000, targetPrice + 5000);
                        userPreferences.priceRange = { value: {min: minPrice, max: maxPrice}, weight: 3, description: `price around $${targetPrice.toLocaleString()}` };
                        addChatMessage(`Great! Searching for cars around $${targetPrice.toLocaleString()}.`, 'ai');
                        processed = true;
                    }
                    break;

                case 'carType':
                    if (lowerInput.includes('suv')) {
                        userPreferences.carType = { value: 'SUV', weight: 3, description: "an SUV" };
                        addChatMessage("SUVs it is! Great for versatility and space.", 'ai');
                        processed = true;
                    } else if (lowerInput.includes('sedan')) {
                        userPreferences.carType = { value: 'Sedan', weight: 3, description: "a Sedan" };
                        addChatMessage("Sedans are excellent for comfort and fuel efficiency!", 'ai');
                        processed = true;
                    } else if (lowerInput.includes('truck')) {
                        userPreferences.carType = { value: 'Truck', weight: 3, description: "a Truck" };
                        addChatMessage("Trucks are perfect for hauling and capability!", 'ai');
                        processed = true;
                    } else if (lowerInput.includes('electric') || lowerInput.includes('ev')) {
                        userPreferences.carType = { value: 'EV', weight: 3, description: "an Electric Vehicle" };
                        addChatMessage("Electric vehicles - great choice for the environment and efficiency!", 'ai');
                        processed = true;
                    }
                    break;

                case 'brand':
                    if (lowerInput.includes('no preference')) {
                        addChatMessage("No problem! I'll consider all brands.", 'ai');
                        processed = true;
                    } else {
                        const knownBrands = ["honda", "toyota", "tesla", "ford", "bmw", "chevrolet", "hyundai"];
                        for (const brand of knownBrands) {
                            if (lowerInput.includes(brand)) {
                                let displayBrand = brand.charAt(0).toUpperCase() + brand.slice(1);
                                userPreferences.brand = { value: displayBrand, weight: 2, description: `brand preference: ${displayBrand}` };
                                addChatMessage(`${displayBrand} is a great choice!`, 'ai');
                                processed = true;
                                break;
                            }
                        }
                    }
                    break;

                case 'seatingCapacity':
                    const seatMatch = lowerInput.match(/(\d+)/);
                    if (seatMatch) {
                        const seatingValue = parseInt(seatMatch[1], 10);
                        userPreferences.seatingCapacity = { value: seatingValue, weight: 2, description: `at least ${seatingValue} seats` };
                        addChatMessage(`Perfect! Looking for cars with at least ${seatingValue} seats.`, 'ai');
                        processed = true;
                    }
                    break;

                case 'minMPGHighway':
                    if (lowerInput.includes('not important')) {
                        addChatMessage("Understood! Fuel efficiency won't be a priority.", 'ai');
                        processed = true;
                    } else if (lowerInput.includes('yes')) {
                        userPreferences.minMPGHighway = { value: 30, weight: 2, description: "good highway MPG" };
                        addChatMessage("Great! I'll prioritize fuel-efficient vehicles.", 'ai');
                        processed = true;
                    } else {
                        const mpgMatch = lowerInput.match(/(\d+)/);
                        if (mpgMatch) {
                            const mpgValue = parseInt(mpgMatch[1], 10);
                            userPreferences.minMPGHighway = { value: mpgValue, weight: 2, description: `highway MPG of at least ${mpgValue}` };
                            addChatMessage(`Got it! Looking for cars with at least ${mpgValue} highway MPG.`, 'ai');
                            processed = true;
                        }
                    }
                    break;
            }

            if (processed) {
                guidedStep++;
                updateFacetUI();
                updateCarDisplay();
                setTimeout(() => askNextGuidedQuestion(), 500); // Small delay before next question
            } else {
                addChatMessage("I didn't quite understand that. Could you please try again?", 'ai');
            }
        }

        // Simulates AI processing and updating preferences
        async function processUserInput(input) {
            addChatMessage(input, 'user');
            userInput.value = ''; // Clear input immediately

            // Show a loading indicator
            const loadingDiv = document.createElement('div');
            loadingDiv.classList.add('chat-message', 'ai', 'p-3', 'my-2', 'max-w-[80%]', 'shadow-sm', 'loading-dots');
            loadingDiv.innerHTML = '<span>.</span><span>.</span><span>.</span>';
            chatMessagesDiv.appendChild(loadingDiv);
            chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;

            // Simulate AI thinking time
            await new Promise(resolve => setTimeout(resolve, 1000 + Math.random() * 1000));

            // Remove loading indicator
            chatMessagesDiv.removeChild(loadingDiv);

            const lowerInput = input.toLowerCase();

            // Check if user wants guided experience
            if (lowerInput.includes('guide me') || lowerInput.includes('guide')) {
                addChatMessage("I'd be happy to guide you! I'll ask you a few questions to find your perfect car.", 'ai');
                startGuidedExperience();
                return;
            }

            // If we're in guided mode, process the response differently
            if (isGuided) {
                processGuidedResponse(input);
                return;
            }

            let aiResponse = "I'm not sure how to interpret that. Can you tell me more about what you're looking for?";
            let preferenceUpdated = false;

            // --- Preference Parsing Logic (simplified for demo) ---
            // Brand preference
            const knownBrands = [
                "honda", "toyota", "tesla", "subaru", "ford", "bmw", "nissan", "mercedes", "mercedes-benz", "jeep", "hyundai", "audi", "chevrolet", "mazda", "lexus", "ram", "volkswagen"
            ];
            let foundBrand = null;
            for (const brand of knownBrands) {
                if (lowerInput.includes(brand)) {
                    foundBrand = brand;
                    break;
                }
            }
            if (foundBrand) {
                let displayBrand = foundBrand === "mercedes" ? "Mercedes-Benz" : foundBrand.charAt(0).toUpperCase() + foundBrand.slice(1);
                userPreferences.brand = { value: displayBrand, weight: 2, description: `brand preference: ${displayBrand}` };
                aiResponse = `Focusing on cars from ${displayBrand}.`;
                preferenceUpdated = true;
            }
            else if (lowerInput.includes("gas mileage") || lowerInput.includes("mpg")) {
                const match = lowerInput.match(/(\d+)\s*(mpg|miles per gallon)/);
                if (match) {
                    const mpgValue = parseInt(match[1], 10);
                    userPreferences.minMPGHighway = { value: mpgValue, weight: 2, description: `highway MPG of at least ${mpgValue}` };
                    aiResponse = `Okay, I'll prioritize cars with at least ${mpgValue} highway MPG.`;
                    preferenceUpdated = true;
                } else {
                    userPreferences.minMPGHighway = { value: 30, weight: 2, description: "good highway MPG" };
                    aiResponse = "Got it, looking for good gas mileage. I'll prioritize cars with high highway MPG.";
                    preferenceUpdated = true;
                }
            } else if (lowerInput.includes("price") || lowerInput.includes("budget") || lowerInput.includes("cost")) {
                const rangeMatch = lowerInput.match(/between\s*\$*(\d+k?|\d+)\s*and\s*\$*(\d+k?|\d+)/);
                const underMatch = lowerInput.match(/under\s*\$*(\d+k|\d+)/);
                const overMatch = lowerInput.match(/over\s*\$*(\d+k|\d+)/);
                const aroundMatch = lowerInput.match(/around\s*\$*(\d+k|\d+)/);
                
                if (rangeMatch) {
                    let minPrice = parseInt(rangeMatch[1].replace('k', '000'), 10);
                    let maxPrice = parseInt(rangeMatch[2].replace('k', '000'), 10);
                    userPreferences.priceRange = { value: {min: minPrice, max: maxPrice}, weight: 3, description: `price between $${minPrice.toLocaleString()} and $${maxPrice.toLocaleString()}` };
                    aiResponse = `Searching for cars between $${minPrice.toLocaleString()} and $${maxPrice.toLocaleString()}.`;
                    preferenceUpdated = true;
                } else if (underMatch) {
                    let maxPrice = parseInt(underMatch[1].replace('k', '000'), 10);
                    userPreferences.priceRange = { value: {min: 10000, max: maxPrice}, weight: 3, description: `price under $${maxPrice.toLocaleString()}` };
                    aiResponse = `Searching for cars under $${maxPrice.toLocaleString()}.`;
                    preferenceUpdated = true;
                } else if (overMatch) {
                    let minPrice = parseInt(overMatch[1].replace('k', '000'), 10);
                    userPreferences.priceRange = { value: {min: minPrice, max: 100000}, weight: 3, description: `price over $${minPrice.toLocaleString()}` };
                    aiResponse = `Searching for cars over $${minPrice.toLocaleString()}.`;
                    preferenceUpdated = true;
                } else if (aroundMatch) {
                    let targetPrice = parseInt(aroundMatch[1].replace('k', '000'), 10);
                    let minPrice = Math.max(10000, targetPrice - 5000);
                    let maxPrice = Math.min(100000, targetPrice + 5000);
                    userPreferences.priceRange = { value: {min: minPrice, max: maxPrice}, weight: 3, description: `price around $${targetPrice.toLocaleString()}` };
                    aiResponse = `Searching for cars around $${targetPrice.toLocaleString()} (between $${minPrice.toLocaleString()} and $${maxPrice.toLocaleString()}).`;
                    preferenceUpdated = true;
                } else {
                    userPreferences.priceRange = { value: {min: 10000, max: 40000}, weight: 3, description: "affordable price range" };
                    aiResponse = "Okay, I'll look for cars in an affordable price range.";
                    preferenceUpdated = true;
                }
            } else if (lowerInput.includes("awd") || lowerInput.includes("all-wheel drive")) {
                if (!userPreferences.features) userPreferences.features = { value: [], weight: 1, description: "specific features" };
                if (!userPreferences.features.value.includes('AWD')) {
                    userPreferences.features.value.push('AWD');
                    aiResponse = "Adding 'AWD' to your desired features.";
                    preferenceUpdated = true;
                } else {
                    aiResponse = "You already mentioned AWD!";
                }
            } else if (lowerInput.includes("fwd") || lowerInput.includes("front-wheel drive") || lowerInput.includes("front wheel drive")) {
                if (!userPreferences.features) userPreferences.features = { value: [], weight: 1, description: "specific features" };
                if (!userPreferences.features.value.includes('FWD')) {
                    userPreferences.features.value.push('FWD');
                    aiResponse = "Adding 'FWD' to your desired features.";
                    preferenceUpdated = true;
                } else {
                    aiResponse = "You already mentioned FWD!";
                }
            } else if (lowerInput.includes("apple carplay")) {
                if (!userPreferences.features) userPreferences.features = { value: [], weight: 1, description: "specific features" };
                if (!userPreferences.features.value.includes('Apple CarPlay')) {
                    userPreferences.features.value.push('Apple CarPlay');
                    aiResponse = "Adding 'Apple CarPlay' to your desired features.";
                    preferenceUpdated = true;
                } else {
                    aiResponse = "You already mentioned Apple CarPlay!";
                }
            } else if (lowerInput.includes("suv")) {
                userPreferences.carType = { value: 'SUV', weight: 3, description: "an SUV" };
                aiResponse = "Prioritizing SUVs for you.";
                preferenceUpdated = true;
            } else if (lowerInput.includes("sedan")) {
                userPreferences.carType = { value: 'Sedan', weight: 3, description: "a Sedan" };
                aiResponse = "Focusing on Sedans for your search.";
                preferenceUpdated = true;
            } else if (lowerInput.includes("electric") || lowerInput.includes("ev")) {
                userPreferences.carType = { value: 'EV', weight: 3, description: "an Electric Vehicle" };
                aiResponse = "Looking into Electric Vehicles for you.";
                preferenceUpdated = true;
            } else if (lowerInput.includes("seats") || lowerInput.includes("seating")) {
                const match = lowerInput.match(/(\d+)\s*seats?/);
                if (match) {
                    const seatingValue = parseInt(match[1], 10);
                    userPreferences.seatingCapacity = { value: seatingValue, weight: 2, description: `at least ${seatingValue} seats` };
                    aiResponse = `Okay, prioritizing cars with at least ${seatingValue} seats.`;
                    preferenceUpdated = true;
                } else {
                    userPreferences.seatingCapacity = { value: 5, weight: 2, description: "at least 5 seats." };
                    aiResponse = "Looking for cars with good seating capacity, at least 5 seats.";
                    preferenceUpdated = true;
                }
            } else if (lowerInput.includes("reset") || lowerInput.includes("clear preferences")) {
                resetPreferences(); // Call the new reset function
                aiResponse = "Okay, I've cleared all your preferences. What would you like to start with? You can also say 'guide me' for a step-by-step experience!";
                preferenceUpdated = true;
            }

            addChatMessage(aiResponse, 'ai');

            if (preferenceUpdated) {
                updateFacetUI(); // Update facets after AI changes preferences
                updateCarDisplay(); // Re-rank and re-render if preferences changed
            }
        }

        // --- Ranking Algorithm ---
        function rankCars(cars, userPreferences) {
            const rankedCars = cars.map(car => {
                let score = 0;
                const matchedCriteria = [];
                const unmatchedCriteria = [];

                // --- Evaluate Brand ---
                if (userPreferences.brand && userPreferences.brand.value) {
                    let carBrand = car.make;
                    if (carBrand.toLowerCase() === userPreferences.brand.value.toLowerCase()) {
                        score += userPreferences.brand.weight;
                        matchedCriteria.push(`Matches brand preference: ${carBrand}.`);
                    } else {
                        unmatchedCriteria.push(`Does not match brand preference (actual: ${carBrand}, desired: ${userPreferences.brand.value}).`);
                    }
                }
                // --- Evaluate MPG ---
                if (userPreferences.minMPGHighway && userPreferences.minMPGHighway.value > 0) {
                    if (car.mpg.highway >= userPreferences.minMPGHighway.value) {
                        score += userPreferences.minMPGHighway.weight;
                        matchedCriteria.push(`Meets highway MPG preference (${car.mpg.highway} MPG vs. desired ${userPreferences.minMPGHighway.value}+ MPG).`);
                    } else {
                        unmatchedCriteria.push(`Does not meet highway MPG preference (actual: ${car.mpg.highway} MPG, desired: ${userPreferences.minMPGHighway.value}+ MPG).`);
                    }
                }

                // --- Evaluate Price ---
                if (userPreferences.priceRange && userPreferences.priceRange.value) {
                    const minPrice = userPreferences.priceRange.value.min;
                    const maxPrice = userPreferences.priceRange.value.max;
                    if (car.price >= minPrice && car.price <= maxPrice) {
                        score += userPreferences.priceRange.weight;
                        matchedCriteria.push(`Meets price range preference ($${car.price.toLocaleString()} within $${minPrice.toLocaleString()} - $${maxPrice.toLocaleString()}).`);
                    } else {
                        unmatchedCriteria.push(`Does not meet price range preference (actual: $${car.price.toLocaleString()}, desired: $${minPrice.toLocaleString()} - $${maxPrice.toLocaleString()}).`);
                    }
                }

                // --- Evaluate Features ---
                if (userPreferences.features && userPreferences.features.value.length > 0) {
                    let featuresMatchedCount = 0;
                    const missingFeatures = [];
                    userPreferences.features.value.forEach(prefFeature => {
                        if (car.features.includes(prefFeature)) {
                            featuresMatchedCount++;
                        } else {
                            missingFeatures.push(prefFeature);
                        }
                    });

                    if (featuresMatchedCount === userPreferences.features.value.length) {
                        score += userPreferences.features.weight;
                        matchedCriteria.push(`Has all desired features: ${userPreferences.features.value.join(', ')}.`);
                    } else if (featuresMatchedCount > 0) {
                        score += userPreferences.features.weight * (featuresMatchedCount / userPreferences.features.value.length); // Partial score
                        matchedCriteria.push(`Has some desired features (${featuresMatchedCount}/${userPreferences.features.value.length} found).`);
                        unmatchedCriteria.push(`Missing features: ${missingFeatures.join(', ')}.`);
                    } else {
                        unmatchedCriteria.push(`Does not have any of the desired features: ${userPreferences.features.value.join(', ')}.`);
                    }
                }

                // --- Evaluate Seating Capacity ---
                if (userPreferences.seatingCapacity && userPreferences.seatingCapacity.value > 0) {
                    if (car.seating >= userPreferences.seatingCapacity.value) {
                        score += userPreferences.seatingCapacity.weight;
                        matchedCriteria.push(`Meets seating capacity preference (${car.seating} seats vs. desired ${userPreferences.seatingCapacity.value}+ seats).`);
                    } else {
                        unmatchedCriteria.push(`Does not meet seating capacity preference (actual: ${car.seating} seats, desired: ${userPreferences.seatingCapacity.value}+ seats).`);
                    }
                }

                // --- Evaluate Car Type ---
                if (userPreferences.carType && userPreferences.carType.value) {
                    if (car.type === userPreferences.carType.value) {
                        score += userPreferences.carType.weight;
                        matchedCriteria.push(`Matches desired car type: ${car.type}.`);
                    } else {
                        unmatchedCriteria.push(`Does not match desired car type (actual: ${car.type}, desired: ${userPreferences.carType.value}).`);
                    }
                }

                const hasPreferences = Object.values(userPreferences).some(pref => pref !== null && (pref.value !== '' && pref.value !== 0 && (Array.isArray(pref.value) ? pref.value.length > 0 : true)));
                const isPerfectMatch = hasPreferences && unmatchedCriteria.length === 0; // Perfect match only if some preferences exist and all are met
                const isPartialMatch = hasPreferences && unmatchedCriteria.length > 0 && matchedCriteria.length > 0; // Partial match if preferences exist and some match but not all
                const isNoMatch = hasPreferences && matchedCriteria.length === 0; // No match if preferences exist but none match

                return {
                    ...car,
                    score,
                    isPerfectMatch,
                    isPartialMatch,
                    isNoMatch,
                    matchedCriteria,
                    unmatchedCriteria
                };
            });

            // Sort: perfect matches first, then by score, then randomize for ties
            rankedCars.sort((a, b) => {
                if (a.isPerfectMatch && !b.isPerfectMatch) return -1;
                if (!a.isPerfectMatch && b.isPerfectMatch) return 1;
                if (b.score !== a.score) return b.score - a.score; // Higher score first
                return Math.random() - 0.5; // Randomize for ties instead of price sorting
            });

            return rankedCars;
        }

        // --- FLIP Animation and Rendering ---
        function renderCarList(newlyRankedCars) {
            const currentCarElements = Array.from(carListContainer.children);

            // 1. FIRST: Record initial positions
            const firstPositions = {};
            currentCarElements.forEach(carEl => {
                const id = carEl.dataset.carId;
                // Temporarily disable animation and scale transform to get accurate position measurements
                const wasOnlyPerfectMatch = carEl.classList.contains('only-perfect-match');
                if (wasOnlyPerfectMatch) {
                    carEl.style.animation = 'none';
                    carEl.style.transform = 'scale(1)';
                }
                firstPositions[id] = carEl.getBoundingClientRect();
                // Restore the animation and scale if it was there
                if (wasOnlyPerfectMatch) {
                    carEl.style.animation = '';
                    carEl.style.transform = '';
                }
            });

            // 2. LAST: Update the DOM with the new order
            // Clear existing elements
            while (carListContainer.firstChild) {
                carListContainer.removeChild(carListContainer.firstChild);
            }

            // Append new elements in the sorted order
            newlyRankedCars.forEach(car => {
                const carEl = document.createElement('div');
                carEl.classList.add('car-item', 'p-4', 'flex', 'flex-col', 'items-center', 'text-center');
                carEl.dataset.carId = car.id;

                // Count perfect matches to determine if this is the only one
                const perfectMatchCount = newlyRankedCars.filter(c => c.isPerfectMatch).length;

                // Apply styling based on match level: perfect (active), partial, or no match (inactive)
                if (car.isPerfectMatch) {
                    carEl.classList.add('active');
                    // Add special styling if this is the ONLY perfect match
                    if (perfectMatchCount === 1) {
                        carEl.classList.add('only-perfect-match');
                    }
                } else if (car.isPartialMatch) {
                    carEl.classList.add('partial');
                } else if (car.isNoMatch) {
                    carEl.classList.add('inactive');
                }

                // Conditionally render tooltip based on userPreferences
                const hasPreferences = Object.values(userPreferences).some(pref => pref !== null && (pref.value !== '' && pref.value !== 0 && (Array.isArray(pref.value) ? pref.value.length > 0 : true)));

                const tooltipHtml = hasPreferences ? `
                    <div class="tooltip">
                        ${car.isPerfectMatch && car.matchedCriteria.length > 0 ?
                            `<strong>Why this car is right for you:</strong><ul>${car.matchedCriteria.map(c => `<li>${c}</li>`).join('')}</ul>` :
                            `<strong>Why this car doesn't fit all preferences:</strong><ul>${car.unmatchedCriteria.map(c => `<li>${c}</li>`).join('')}</ul>
                             ${car.matchedCriteria.length > 0 ? `<strong>It does match:</strong><ul>${car.matchedCriteria.map(c => `<li>${c}</li>`).join('')}</ul>` : ''}`
                        }
                    </div>
                ` : '';

                // Group non-tooltip content for opacity
                const contentHtml = `
                    <div class="car-content">
                        <img src="${car.imageUrl}" alt="${car.make} ${car.model}" class="w-full h-32 object-cover rounded-lg mb-3">
                        <h3 class="text-lg font-semibold text-gray-900 mb-1">${car.make} ${car.model}</h3>
                        <p class="text-blue-600 text-lg font-bold mb-2">$${car.price.toLocaleString()}</p>
                        
                        <div class="space-y-2 text-xs text-gray-600">
                            <div class="flex justify-between">
                                <span>Type:</span>
                                <span class="font-medium">${car.type}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Seating:</span>
                                <span class="font-medium">${car.seating} seats</span>
                            </div>
                            <div class="flex justify-between">
                                <span>MPG:</span>
                                <span class="font-medium">${car.mpg.city}/${car.mpg.highway} (city/hwy)</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Safety Rating:</span>
                                <span class="font-medium">${'★'.repeat(car.safetyRating)}${' ☆'.repeat(5 - car.safetyRating)}</span>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <p class="text-xs text-gray-500 mb-1">Key Features:</p>
                            <div class="flex flex-wrap gap-1">
                                ${car.features.slice(0, 3).map(feature => 
                                    `<span class="bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs">${feature}</span>`
                                ).join('')}
                                ${car.features.length > 3 ? `<span class="text-xs text-gray-500">+${car.features.length - 3} more</span>` : ''}
                            </div>
                        </div>
                    </div>
                    ${tooltipHtml}
                `;
                carEl.innerHTML = contentHtml;
                carListContainer.appendChild(carEl);
            });

            // 3. INVERT & 4. PLAY: Animate to new positions
            // Re-select elements as DOM has changed
            const newCarElements = Array.from(carListContainer.children);

            newCarElements.forEach(carEl => {
                const id = carEl.dataset.carId;
                // Temporarily disable animation and scale transform to get accurate position measurements
                const isOnlyPerfectMatch = carEl.classList.contains('only-perfect-match');
                if (isOnlyPerfectMatch) {
                    carEl.style.animation = 'none';
                    carEl.style.transform = 'scale(1)';
                }
                const lastPosition = carEl.getBoundingClientRect();
                const firstPosition = firstPositions[id];

                if (firstPosition) { // Only animate if the element was present before
                    const deltaX = firstPosition.left - lastPosition.left;
                    const deltaY = firstPosition.top - lastPosition.top;

                    carEl.style.transition = 'none'; // Disable transition for the "invert" step
                    carEl.style.transform = `translate(${deltaX}px, ${deltaY}px)${isOnlyPerfectMatch ? ' scale(1.05)' : ''}`;

                    // Force a repaint to ensure the transform is applied before the transition
                    // eslint-disable-next-line no-unused-expressions
                    carEl.offsetWidth;

                    carEl.style.transition = 'transform 0.5s ease-out'; // Enable transition
                    carEl.style.transform = isOnlyPerfectMatch ? 'translate(0, 0) scale(1.05)' : 'translate(0, 0)'; // Animate back to final position with proper scale
                    
                    // After the transition completes, restore the CSS animation
                    if (isOnlyPerfectMatch) {
                        carEl.addEventListener('transitionend', () => {
                            carEl.style.animation = '';
                            carEl.style.transform = '';
                            carEl.style.transition = '';
                        }, { once: true });
                    }
                } else {
                    // Handle newly added elements (e.g., fade in)
                    if (isOnlyPerfectMatch) {
                        carEl.style.animation = 'none';
                    }
                    carEl.style.opacity = '0';
                    setTimeout(() => {
                        carEl.style.transition = 'opacity 0.5s ease-in';
                        carEl.style.opacity = '1';
                        // Restore animation after fade in
                        if (isOnlyPerfectMatch) {
                            setTimeout(() => {
                                carEl.style.animation = '';
                            }, 500);
                        }
                    }, 50); // Small delay to allow initial render
                }
            });

            // Handle removed elements (e.g., fade out and remove)
            currentCarElements.forEach(oldCarEl => {
                const id = oldCarEl.dataset.carId;
                const isStillPresent = newlyRankedCars.some(car => car.id === id);
                if (!isStillPresent) {
                    oldCarEl.style.transition = 'opacity 0.5s ease-out, transform 0.5s ease-out';
                    oldCarEl.style.opacity = '0';
                    oldCarEl.style.transform = 'scale(0.9)';
                    oldCarEl.addEventListener('transitionend', () => oldCarEl.remove(), { once: true });
                }
            });
        }

        // --- Drawer Toggle Functionality ---
        function toggleDrawer() {
            if (isDrawerOpen) {
                // Close the drawer
                chatDrawer.classList.remove('chat-drawer-open');
                chatDrawer.classList.add('chat-drawer-closed');
                carListContainerWrapper.classList.remove('w-3/5', 'mr-4'); // Adjust for new layout
                carListContainerWrapper.classList.add('w-4/5'); // Car list takes more space
                chatContent.classList.add('hidden'); // Hide content immediately
                chatDrawerHeader.classList.add('hidden'); // Hide header content
                toggleIconOpen.classList.add('hidden');
                toggleIconClosed.classList.remove('hidden');
            } else {
                // Open the drawer
                chatDrawer.classList.remove('chat-drawer-closed');
                chatDrawer.classList.add('chat-drawer-open');
                carListContainerWrapper.classList.remove('w-4/5'); // Car list shrinks
                carListContainerWrapper.classList.add('w-3/5', 'mr-4'); // Adjust for new layout
                chatContent.classList.remove('hidden'); // Show content
                chatDrawerHeader.classList.remove('hidden'); // Show header content
                toggleIconOpen.classList.remove('hidden');
                toggleIconClosed.classList.add('hidden');
            }
            isDrawerOpen = !isDrawerOpen; // Toggle the state
        }

        // --- Facet Initialization and Update ---
        function initializeFacets() {
            // Populate Brand Select
            const brands = [...new Set(cars.map(car => car.make))].sort();
            brands.forEach(brand => {
                const option = document.createElement('option');
                option.value = brand;
                option.textContent = brand;
                facetBrandSelect.appendChild(option);
            });

            // Populate Car Type Checkboxes
            const carTypes = [...new Set(cars.map(car => car.type))].sort();
            carTypes.forEach(type => {
                const div = document.createElement('div');
                div.classList.add('flex', 'items-center');
                div.innerHTML = `
                    <input type="checkbox" id="car-type-${type.toLowerCase().replace(/\s/g, '-')}" value="${type}" class="form-checkbox h-4 w-4 text-blue-600 rounded">
                    <label for="car-type-${type.toLowerCase().replace(/\s/g, '-')}" class="ml-2 text-sm">${type}</label>
                `;
                facetCarTypeDiv.appendChild(div);
            });

            // Populate Features Checkboxes (only unique features)
            const allFeatures = cars.flatMap(car => car.features);
            const uniqueFeatures = [...new Set(allFeatures)].sort();
            uniqueFeatures.forEach(feature => {
                const div = document.createElement('div');
                div.classList.add('flex', 'items-center');
                div.innerHTML = `
                    <input type="checkbox" id="feature-${feature.toLowerCase().replace(/\s/g, '-')}" value="${feature}" class="form-checkbox h-4 w-4 text-blue-600 rounded">
                    <label for="feature-${feature.toLowerCase().replace(/\s/g, '-')}" class="ml-2 text-sm">${feature}</label>
                `;
                facetFeaturesDiv.appendChild(div);
            });

            // Set initial values for sliders and display them
            facetPriceMin.value = 10000; // Min price initially
            facetPriceMax.value = 100000; // Max price initially
            facetPriceMinValueSpan.textContent = `${parseInt(facetPriceMin.value).toLocaleString()}`;
            facetPriceMaxValueSpan.textContent = `${parseInt(facetPriceMax.value).toLocaleString()}`;
            facetMpgRange.value = 10; // Min MPG initially
            facetMpgValueSpan.textContent = `${parseInt(facetMpgRange.value)}`;

            // Add event listeners for facets
            facetBrandSelect.addEventListener('change', handleFacetChange);
            facetCarTypeDiv.addEventListener('change', handleFacetChange);
            facetPriceMin.addEventListener('input', handleFacetChange); // Use 'input' for continuous update
            facetPriceMax.addEventListener('input', handleFacetChange);
            facetMpgRange.addEventListener('input', handleFacetChange);
            facetSeatingSelect.addEventListener('change', handleFacetChange);
            facetFeaturesDiv.addEventListener('change', handleFacetChange);
            facetResetButton.addEventListener('click', resetPreferences);

            // Update display for sliders on input
            facetPriceMin.addEventListener('input', () => {
                const minVal = parseInt(facetPriceMin.value);
                const maxVal = parseInt(facetPriceMax.value);
                // Ensure min doesn't exceed max
                if (minVal > maxVal) {
                    facetPriceMax.value = minVal;
                    facetPriceMaxValueSpan.textContent = `${minVal.toLocaleString()}`;
                }
                facetPriceMinValueSpan.textContent = `${minVal.toLocaleString()}`;
            });
            facetPriceMax.addEventListener('input', () => {
                const minVal = parseInt(facetPriceMin.value);
                const maxVal = parseInt(facetPriceMax.value);
                // Ensure max doesn't go below min
                if (maxVal < minVal) {
                    facetPriceMin.value = maxVal;
                    facetPriceMinValueSpan.textContent = `${maxVal.toLocaleString()}`;
                }
                facetPriceMaxValueSpan.textContent = `${maxVal.toLocaleString()}`;
            });
            facetMpgRange.addEventListener('input', () => {
                facetMpgValueSpan.textContent = `${parseInt(facetMpgRange.value)}`;
            });
        }

        function handleFacetChange() {
            // Update userPreferences based on current facet values
            userPreferences.brand = facetBrandSelect.value ? { value: facetBrandSelect.value, weight: 2, description: `brand preference: ${facetBrandSelect.value}` } : null;
            
            const minPrice = parseInt(facetPriceMin.value);
            const maxPrice = parseInt(facetPriceMax.value);
            userPreferences.priceRange = (minPrice > 10000 || maxPrice < 100000) ? { 
                value: {min: minPrice, max: maxPrice}, 
                weight: 3, 
                description: `price range: $${minPrice.toLocaleString()} - $${maxPrice.toLocaleString()}` 
            } : null;
            
            userPreferences.minMPGHighway = parseInt(facetMpgRange.value) > 10 ? { value: parseInt(facetMpgRange.value), weight: 2, description: `highway MPG of at least ${parseInt(facetMpgRange.value)}` } : null;
            userPreferences.seatingCapacity = parseInt(facetSeatingSelect.value) > 0 ? { value: parseInt(facetSeatingSelect.value), weight: 2, description: `at least ${parseInt(facetSeatingSelect.value)} seats` } : null;

            const selectedCarTypes = Array.from(facetCarTypeDiv.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
            userPreferences.carType = selectedCarTypes.length > 0 ? { value: selectedCarTypes[0], weight: 3, description: `car type: ${selectedCarTypes[0]}` } : null; // For simplicity, only take the first selected type if multiple are allowed by UI

            const selectedFeatures = Array.from(facetFeaturesDiv.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
            userPreferences.features = selectedFeatures.length > 0 ? { value: selectedFeatures, weight: 1, description: `specific features: ${selectedFeatures.join(', ')}` } : null;

            updateCarDisplay();
        }

        function updateFacetUI() {
            // Update Brand Select
            facetBrandSelect.value = userPreferences.brand ? userPreferences.brand.value : '';

            // Update Price Sliders
            if (userPreferences.priceRange) {
                facetPriceMin.value = userPreferences.priceRange.value.min;
                facetPriceMax.value = userPreferences.priceRange.value.max;
            } else {
                facetPriceMin.value = 10000;
                facetPriceMax.value = 100000;
            }
            facetPriceMinValueSpan.textContent = `${parseInt(facetPriceMin.value).toLocaleString()}`;
            facetPriceMaxValueSpan.textContent = `${parseInt(facetPriceMax.value).toLocaleString()}`;

            // Update MPG Slider
            facetMpgRange.value = userPreferences.minMPGHighway ? userPreferences.minMPGHighway.value : 10;
            facetMpgValueSpan.textContent = `${parseInt(facetMpgRange.value)}`;

            // Update Seating Select
            facetSeatingSelect.value = userPreferences.seatingCapacity ? userPreferences.seatingCapacity.value : '';

            // Update Car Type Checkboxes
            const carTypeCheckboxes = facetCarTypeDiv.querySelectorAll('input[type="checkbox"]');
            carTypeCheckboxes.forEach(cb => {
                cb.checked = (userPreferences.carType && userPreferences.carType.value === cb.value);
            });

            // Update Features Checkboxes
            const featureCheckboxes = facetFeaturesDiv.querySelectorAll('input[type="checkbox"]');
            featureCheckboxes.forEach(cb => {
                cb.checked = (userPreferences.features && userPreferences.features.value.includes(cb.value));
            });
        }

        function resetPreferences() {
            userPreferences = {
                brand: null,
                priceRange: null,
                minMPGHighway: null,
                seatingCapacity: null,
                carType: null,
                features: null
            };
            isGuided = false;
            guidedStep = 0;
            updateFacetUI(); // Reset UI elements
            updateCarDisplay(); // Re-render cars
            addChatMessage("All filters have been reset.", "ai");
        }


        // --- Event Listeners ---
        sendButton.addEventListener('click', () => {
            if (userInput.value.trim() !== '') {
                processUserInput(userInput.value.trim());
            }
        });

        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && userInput.value.trim() !== '') {
                processUserInput(e.target.value.trim());
            }
        });

        drawerToggle.addEventListener('click', toggleDrawer);

        // Initial render on page load
        window.onload = () => {
            initializeFacets(); // Initialize facets first
            updateCarDisplay();
            // Ensure drawer starts open
            if (!isDrawerOpen) {
                toggleDrawer(); // Call once if it's not open
            }
        };

        function updateCarDisplay() {
            const sortedCars = rankCars(cars, userPreferences);
            renderCarList(sortedCars);
        }

    </script>
</body>
</html>
